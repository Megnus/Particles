
<!--[if IE]><script type="text/javascript" src="/public/path/flash_backend.js"></script><![endif]-->
<body></body>
<script language="Javascript">
	document.body.style.backgroundColor="#000";
	var span, ctx;

	var data;
	var dir = 0;
	var mx = 640;
	var my = 400;
	var XparticleSpeed = 20;

	var Xparticle = new Array();
	var template = new Array();
	var mouseDown = false;
	var mouseOver = true;

	window.onload = init;

	function init() {
		var image;
		function init() {
			span = document.createElement('span');
			span.style.color = '#FFF';
			span.innerHTML = "0 fps";
			span.style.marginLeft = "30px";
			document.body.appendChild(span);

			image = new Image();
			image.src = 'panagora.png';

			image.onload = function() {
				var canvas = new canvasClass(image);
				var particleArray = new particles();
				particleArray.drawparticles();
			}
		}

		init();
	}

	canvasClass = function(image) {
		var canvas = document.createElement("canvas");
		var	mouseButtonEvent = function(e) {
					mouseDown = e.type === 'mousedown';
				},
			mouseMoveEvent = function(event) {
					mx = event.clientX - 35;
					my = event.clientY - 35;
				},
			mouseEnter = function(e) {
				mouseOver = e.type === 'mouseover';
				};
		canvas.width = image.width;
		canvas.height = image.height;
		canvas.addEventListener('mousemove', mouseMoveEvent, true);
		canvas.addEventListener('mousedown', mouseButtonEvent, false);
		canvas.addEventListener('mouseup', mouseButtonEvent, false);
		canvas.onmouseover = mouseEnter;
		canvas.onmouseout = mouseEnter;
		canvas.getContext("2d").drawImage(image, 0, 0);
		ctx = canvas.getContext('2d');
		data = canvas.getContext('2d').getImageData(0, 0, image.width, image.height);
		document.body.appendChild(canvas);
	}

	// -- OOP --
	point = function(x, y) {
		this.x = x;
		this.y = y;
	}

	particle = function(x, y, dx, dy) {
		// Private
		var postition = new point(x,y),
			speed = new point(dx,dy),
			frames = 20,
			getAcceleration = function() {
				return Math.atan2(postition.x - mx, postition.y - my);
			},
			setSpeed = function() {
				var dir = getAcceleration();
				speed.x -= Math.sin(dir);
				speed.y -= Math.cos(dir)
			},
			setPosition = function() {
				postition.x += speed.x * 30 / frames;
				postition.y += speed.y * 30 / frames;
			},
			nextStep = function() {
				setSpeed();
				setPosition();
			}
		// Public
		this.drawparticle = function() {
			setPixel(postition.x, postition.y, 0);
			nextStep();
			setPixel(postition.x, postition.y, 255);
		}
	}

	particles = function() {
		var particleArray = new Array(),
			templateArray = new Array(),
			init = function() {
				for (var x = 0; x < 1280; x++) {
					for (var y = 0; y < 800; y++) {
						if ( getPixel(x,y)[0] > 100 ) {
							particleArray.push(new particle(x, y, Math.random(), Math.random()));
							template.push(new particle(x, y, 0, 0));
						}
					}
				}
			},
			animate = function() {
				for ( var p in particleArray ) {
					particleArray[p].drawparticle();
				}
			}
		this.drawparticles = function() {
			render();
			function render() {
				animate();
				ctx.putImageData(data, 0, 0);
				setTimeout( function() { render() }, 0 );
			}
		}
		init();
	}


	//----------

	function newXparticlePosition(x, y, n) {
		var mx, my;
		var dir = Math.atan2(x - mx, y - my) / Math.PI * 180;

		if ( mouseDown || !mouseOver ) {
			if (!mouseOver) {
				Xparticle[n][1][0] -= ( x - template[n][0] )/50;
				Xparticle[n][1][1] += ( template[n][1] - y )/50;
			} else {
				if (( x - mx ) *( x - mx ) + ( my - y )*( my - y ) < 1000) {
					Xparticle[n][1][0] += -Math.sin(dir * Math.PI / 180 ) * 8;
					Xparticle[n][1][1] += -Math.cos(dir * Math.PI / 180 ) * 8;
				} else {
					Xparticle[n][1][0] -= ( x - mx ) * frames/400;
					Xparticle[n][1][1] += ( my - y ) * frames/400;
				}
			}

			if (Xparticle[n][1][0] < 0 && ( x - mx ) > 0 || Xparticle[n][1][0] > 0 && ( x - mx ) < 0)
				Xparticle[n][1][0] *= 0.8-Math.random() / 10;

			if (Xparticle[n][1][1] < 0 && ( my - y ) < 0 || Xparticle[n][1][1] > 0 && ( my - y ) > 0)
				Xparticle[n][1][1] *= 0.8-Math.random() / 10;

		} else {
			Xparticle[n][1][0] += -Math.sin(dir * Math.PI / 180 );
			Xparticle[n][1][1] += -Math.cos(dir * Math.PI / 180 );
		}

		Xparticle[n][0][0] += Xparticle[n][1][0] * 30 / frames;
		Xparticle[n][0][1] += Xparticle[n][1][1] * 30 / frames;
	}

	function setPixel(x, y, a) {
		if( x < 0 || y < 0 || x > 1280 || y > 800 )
			return;

		var pos = (Math.round(x) + 1280 * Math.round(y)) * 4;
		//console.log(data);
		data.data[pos] = a;
		data.data[pos + 1] = a;
		data.data[pos + 2] = a;
		data.data[pos + 3] = 255;
	}

	function getPixel(x, y) {
		var pixel = [];
		var pos = x + 1280 * y;
		pos *= 4;
		pixel[0] = data.data[pos];
		pixel[1] = data.data[pos + 1]; //force green to 0
		pixel[2] = data.data[pos + 2];
		pixel[3] = data.data[pos + 3]; //force alpha to 100%
		return pixel;
	}

	function checkPixel(x, y) {
		var pos = (x + canvas.width * y) * 4 + 3;
		return data.data[pos] != 0;
	}



	var currentTime;
	var prevTime = +new Date();
	var deltaTime = Number.MAX_VALUE;
	var frames = Number.MAX_VALUE;
	var ccc = 0;
	function draw() {
		//XparticleSpeed *= .1;
		generateData();
		c.putImageData(data, 25, 25);
		if ( false/*mouseDown*/ ) {

			recycle();

		} else {

		if (ccc % 30 === 0)
		{
			currentTime = +new Date();
			deltaTime = currentTime - prevTime;
			frames = Math.round(30000/deltaTime);
			document.getElementById('fps').innerHTML = Math.round(30000/deltaTime);
			prevTime = currentTime;

		}
		ccc++;
		//setTimeout( function() { draw() }, 0 );

		}
	}

	function remove(id)
	{
	    return (elem=document.getElementById(id)).parentNode.removeChild(elem);
	}

</script>
